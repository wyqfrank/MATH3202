# ID, X, Y, Fuel needed (L), Suppressant needed (L)
Sites = [
[0,179,259,140,61],
[1,45,113,241,82],
[2,386,125,207,80],
[3,43,166,366,97],
[4,304,76,201,63],
[5,302,138,209,62],
[6,178,158,123,49],
[7,146,28,293,83],
[8,335,37,111,48],
[9,321,152,131,47],
[10,271,31,244,61],
[11,280,99,131,55],
[12,367,283,250,104],
[13,17,177,154,51],
[14,107,237,154,52],
[15,187,47,317,97],
[16,31,284,139,50],
[17,188,178,67,17],
[18,62,69,100,29],
[19,323,119,122,51],
[20,354,225,89,35],
[21,166,272,203,69],
[22,191,145,143,47],
[23,292,178,225,83],
[24,48,254,98,34],
[25,264,155,242,68],
[26,244,65,126,45],
[27,144,139,143,55],
[28,217,152,98,35],
[29,368,83,130,51],
[30,344,27,82,24],
[31,290,25,118,55],
[32,231,203,0,0],
[33,300,150,98,45],
[34,323,53,0,0],
[35,33,136,192,84],
[36,240,188,159,49],
[37,329,22,122,43],
[38,114,140,335,140],
[39,96,275,0,0],
[40,28,40,145,50],
[41,25,196,184,74],
[42,201,22,69,22],
[43,86,113,0,0],
[44,196,33,116,44],
[45,269,129,88,25],
[46,202,201,269,96],
[47,164,12,192,71],
[48,368,227,115,39],
[49,215,227,212,72],
[50,390,84,95,32],
[51,284,259,112,36],
[52,340,288,267,91],
[53,315,186,159,59],
[54,316,23,130,42],
[55,149,215,91,32]]

# ID, Site1, Site2, Distance (km), Capacity (L)
Roads = [
[0,12,52,31,1350],
[1,52,12,31,1050],
[2,20,52,82,1600],
[3,52,20,82,1600],
[4,13,41,24,1150],
[5,41,13,24,1300],
[6,2,29,59,1400],
[7,29,2,59,1000],
[8,29,50,24,850],
[9,50,29,24,1700],
[10,2,50,52,1150],
[11,50,2,52,750],
[12,19,29,68,1450],
[13,29,19,68,1100],
[14,2,19,79,1200],
[15,19,2,79,700],
[16,12,48,69,1300],
[17,48,12,69,800],
[18,20,48,17,1500],
[19,48,20,17,900],
[20,13,35,44,1350],
[21,35,13,44,1200],
[22,1,35,32,1150],
[23,35,1,32,950],
[24,1,40,93,1500],
[25,40,1,93,800],
[26,21,39,72,800],
[27,39,21,72,1700],
[28,16,39,83,1550],
[29,39,16,83,1300],
[30,1,18,57,900],
[31,18,1,57,1400],
[32,18,40,56,1200],
[33,40,18,56,1250],
[34,11,26,53,1750],
[35,26,11,53,950],
[36,11,45,32,1050],
[37,45,11,32,850],
[38,20,51,80,1000],
[39,51,20,80,800],
[40,51,52,80,1100],
[41,52,51,80,1600],
[42,51,53,95,1700],
[43,53,51,95,1350],
[44,20,53,71,1750],
[45,53,20,71,1300],
[46,30,50,90,1700],
[47,50,30,90,1550],
[48,5,45,41,1500],
[49,45,5,41,750],
[50,5,11,55,1600],
[51,11,5,55,900],
[52,5,19,30,1300],
[53,19,5,30,1400],
[54,11,19,61,900],
[55,19,11,61,900],
[56,5,33,16,1400],
[57,33,5,16,700],
[58,4,19,57,1450],
[59,19,4,57,700],
[60,4,11,39,750],
[61,11,4,39,900],
[62,4,26,71,1550],
[63,26,4,71,1400],
[64,3,41,38,1750],
[65,41,3,38,1350],
[66,3,13,34,800],
[67,13,3,34,950],
[68,3,35,34,1350],
[69,35,3,34,1250],
[70,18,43,53,1500],
[71,43,18,53,1150],
[72,1,43,43,1000],
[73,43,1,43,950],
[74,38,43,48,1550],
[75,43,38,48,1700],
[76,3,38,95,1300],
[77,38,3,95,1500],
[78,27,38,34,1200],
[79,38,27,34,1050],
[80,7,15,52,850],
[81,15,7,52,1050],
[82,7,47,30,1650],
[83,47,7,30,900],
[84,22,28,28,850],
[85,28,22,28,1600],
[86,27,55,82,1150],
[87,55,27,82,1000],
[88,26,44,62,800],
[89,44,26,62,1600],
[90,42,44,15,800],
[91,44,42,15,1100],
[92,15,44,20,1600],
[93,44,15,20,1150],
[94,44,47,43,800],
[95,47,44,43,1300],
[96,0,21,23,750],
[97,21,0,23,1250],
[98,0,49,56,1400],
[99,49,0,56,850],
[100,49,51,80,850],
[101,51,49,80,1050],
[102,0,55,66,1450],
[103,55,0,66,1050],
[104,32,49,37,1450],
[105,49,32,37,1300],
[106,32,36,18,750],
[107,36,32,18,1100],
[108,25,45,29,1100],
[109,45,25,29,1000],
[110,25,28,48,1650],
[111,28,25,48,1550],
[112,25,36,46,1050],
[113,36,25,46,1650],
[114,28,36,49,950],
[115,36,28,49,950],
[116,25,33,44,1550],
[117,33,25,44,950],
[118,9,33,26,1100],
[119,33,9,26,1450],
[120,9,53,36,900],
[121,53,9,36,1200],
[122,33,53,50,800],
[123,53,33,50,750],
[124,9,19,33,1100],
[125,19,9,33,1100],
[126,5,9,26,1300],
[127,9,5,26,1300],
[128,8,30,14,1250],
[129,30,8,14,1100],
[130,8,37,18,1600],
[131,37,8,18,1650],
[132,30,37,16,900],
[133,37,30,16,1700],
[134,10,26,44,1500],
[135,26,10,44,1400],
[136,10,42,91,1150],
[137,42,10,91,750],
[138,17,22,38,800],
[139,22,17,38,1700],
[140,17,28,49,1150],
[141,28,17,49,1300],
[142,14,39,51,1100],
[143,39,14,51,800],
[144,14,21,89,1500],
[145,21,14,89,1150],
[146,14,55,61,900],
[147,55,14,61,1100],
[148,23,33,33,900],
[149,33,23,33,1150],
[150,23,53,28,950],
[151,53,23,28,950],
[152,23,25,38,950],
[153,25,23,38,1000],
[154,23,36,60,1500],
[155,36,23,60,850],
[156,10,31,25,1350],
[157,31,10,25,800],
[158,4,31,56,1400],
[159,31,4,56,1350],
[160,6,22,22,1200],
[161,22,6,22,1150],
[162,6,27,44,1650],
[163,27,6,44,850],
[164,6,17,26,950],
[165,17,6,26,800],
[166,17,55,54,1300],
[167,55,17,54,1700],
[168,17,46,30,850],
[169,46,17,30,1350],
[170,46,55,71,1050],
[171,55,46,71,1250],
[172,46,49,34,1250],
[173,49,46,34,1350],
[174,32,46,34,1350],
[175,46,32,34,1050],
[176,28,46,64,1200],
[177,46,28,64,900],
[178,24,41,70,1750],
[179,41,24,70,750],
[180,16,24,44,1150],
[181,24,16,44,1050],
[182,14,24,76,1700],
[183,24,14,76,1250],
[184,24,39,65,1150],
[185,39,24,65,1050],
[186,31,34,47,1100],
[187,34,31,47,1250],
[188,4,34,37,1650],
[189,34,4,37,1150],
[190,29,34,69,1550],
[191,34,29,69,1750],
[192,8,34,25,850],
[193,34,8,25,900],
[194,34,54,35,1550],
[195,54,34,35,1600],
[196,31,54,30,1050],
[197,54,31,30,1400],
[198,37,54,16,1250],
[199,54,37,16,1000],
[200,8,54,30,1200],
[201,54,8,30,1050]]

from gurobipy import *

m = Model("Brolga")

# Sets

sites = range(len(Sites))
burn_sites = [site[0] for site in Sites if site[3] > 0]
warehouses = [32, 34, 39, 43]
roads = range(len(Roads))

# Data

# Warehouse data (fuel): maximum stock and price per liter
warehouse_max_stock = { 
    32: 2600,  # Warehouse A
    34: 2100,  # Warehouse B
    39: 2900,  # Warehouse C
    43: 2200   # Warehouse D
}

warehouse_price = {
    32: 8.21,  # Warehouse A
    34: 9.10,  # Warehouse B
    39: 7.79,  # Warehouse C
    43: 6.40   # Warehouse D
}

#  Warehouse data (fire suppressant): maximum stock and price per liter
warehouse_max_stock_fire = {
    32: 1100,  # Warehouse A
    34: 800,  # Warehouse B
    39: 900,  # Warehouse C
    43: 900   # Warehouse D
}

warehouse_price_fire = {
    32: 2.97,  # Warehouse A
    34: 4.57,  # Warehouse B
    39: 3.29,  # Warehouse C
    43: 1.32   # Warehouse D
}

## ^ probs better way to do this with a dictionary of dictionaries
## and using a loop to retrieve the data from sites

# Fuel requirements for each burn site
fuel_required = {}
for site in Sites:
    if site[3] > 0:
        fuel_required[site[0]] = site[3]

# Transport cost per liter per km
transport_cost = 0.78  # $/L/km

road_data = {}
for road_id in roads:
    _, from_site, to_site, distance, capacity = Roads[road_id]  
    road_data[road_id] = {
        'from': from_site,
        'to': to_site,
        'distance': distance,
        'capacity': capacity
    }

#  Fire suppressant requirements for each burn site
suppressant_required = {}
for site in Sites:
    if site[4] > 0:
        suppressant_required[site[0]] = site[4]

# Variables 

# Amount of fuel to purchased from warehouse
x = {}
for w in warehouses:
    x[w] = m.addVar(lb=0, ub=warehouse_max_stock[w]) # maximum stock constraint set here

# Flow of fuel along each road
y = {}
for r in roads:
    from_site = road_data[r]['from']
    to_site = road_data[r]['to']
    y[r] = m.addVar(lb=0, name=f"yf_{from_site}_{to_site}")

# Amount of fire suppressant to purchased from warehouse
z = {}
for w in warehouses:
    z[w] = m.addVar(lb=0, ub=warehouse_max_stock_fire[w]) # maximum stock constraint set here

# Flow of fire suppressant along each road
yf = {}
for r in roads:
    from_site = road_data[r]['from']
    to_site = road_data[r]['to']
    yf[r] = m.addVar(lb=0, name=f"yf_{from_site}_{to_site}")

m.update()

# Objective
fuel_purchase_cost = quicksum(warehouse_price[w] * x[w] for w in warehouses)
suppressant_purchase_cost = quicksum(warehouse_price_fire[w] * z[w] for w in warehouses)
transport_cost_expr = quicksum(transport_cost * road_data[r]['distance'] * (y[r] + yf[r]) for r in roads)

m.setObjective(fuel_purchase_cost + suppressant_purchase_cost + transport_cost_expr, GRB.MINIMIZE)

# Constraints

for site_id in burn_sites + warehouses:
    # Outgoing flow (fuel)
    outflow = quicksum(y[r] for r in roads if road_data[r]['from'] == site_id)
    
    # Incoming flow (fuel)
    inflow = quicksum(y[r] for r in roads if road_data[r]['to'] == site_id)
    
    # For warehouses (fuel): outflow - inflow = amount purchased
    if site_id in warehouses:
        m.addConstr(outflow - inflow == x[site_id], name=f"flow_balance_warehouse_{site_id}")
    
    # For burn sites (fuel): inflow - outflow = fuel required
    elif site_id in burn_sites:
        inflow = quicksum(y[r] * (1 - 0.0005 * road_data[r]['distance']) 
                         for r in roads if road_data[r]['to'] == site_id)
        m.addConstr(inflow - outflow == fuel_required[site_id], name=f"flow_balance_burn_{site_id}")

    # Fire suppressant flow balance constraints

    # Outgoing flow (fire suppressant)
    outflow = quicksum(yf[r] for r in roads if road_data[r]['from'] == site_id)

    # Incoming flow (fire suppressant)
    inflow = quicksum(yf[r] for r in roads if road_data[r]['to'] == site_id)

    # For warehouses (fire suppressant): outflow - inflow = amount purchased
    if site_id in warehouses:
        m.addConstr(outflow - inflow == z[site_id], name=f"flow_balance_warehouse_fire_{site_id}")

    # For burn sites (fire suppressant): inflow - outflow = fire suppressant required 
    elif site_id in burn_sites:
        inflow = quicksum(yf[r] for r in roads if road_data[r]['to'] == site_id)
        m.addConstr(inflow - outflow == suppressant_required[site_id], name=f"flow_balance_burn_fire_{site_id}")


# Road capacity constraints
for r in roads:
    capacity = road_data[r]['capacity']
    m.addConstr(y[r] + yf[r] <= capacity, name=f"capacity_road_{r}")
    
m.optimize()
print(m.ObjVal)